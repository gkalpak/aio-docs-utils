####################################################################################################
# WARNING
#
# Secrets are _not_ automatically filtered when targeting Windows on Travis CI ([known issues][1]).
# Make sure no secrets are used in scripts executed on Windows (e.g. no deployments).
# See also [Recommendations on how to avoid leaking secrets to build logs][2].
#
# [1]: https://travis-ci.community/t/current-known-issues-please-read-this-before-posting-a-new-topic/264
# [2]: https://docs.travis-ci.com/user/best-practices-security/#recommendations-on-how-to-avoid-leaking-secrets-to-build-logs
####################################################################################################

os:
  - linux
  - osx
  - windows

dist: trusty
sudo: false

language: node_js
node_js:
  - 10
  - 12
  - node

cache:
  directories:
    - .vscode-test/  # Local `.vscode-test/` directory
    - "$HOME/.npm/"  # Global npm cache.


# Test
before_install:
  - if [ $TRAVIS_OS_NAME == "linux" ]; then
      export DISPLAY=":99.0";
      sh -e /etc/init.d/xvfb start;
    fi
install:
  # The default cache is different on Windows, so ensure the same directory is used on all
  # platforms. (Reference: https://docs.npmjs.com/files/folders.html#cache)
  - npm ci --cache $HOME/.npm/;
script:
  - npm run test-all-versions;


# Deploy
jobs:
  allow_failures:
    # Running e2e tests currently fails on Windows with `Exit code: 3221225781`.
    # (Sample job: https://travis-ci.org/gkalpak/aio-docs-utils/jobs/610835900)
    - os: windows
  include:
    - stage: Deploy
      os: linux
      node_js: node
      if: |
        (branch = master) AND
        (fork = false) AND
        (tag IS present) AND
        (type != pull_request)
      script: skip
      before_deploy:
        - npm run vsce-package;
      deploy:
        # Create a GitHub release.
        - provider: releases
          api_key:
            secure: QN6UNsuZJmqy8qCemtSr8NKcoUIcOBMn929L3zLpvs+Vmd3VWiD+bHwiKdKUo309zRv8EEZnQVUE4qvHKjaUSAijXgNEE3eRPNw/RA2kptj3Dsm0w+jZrrrzauafBfmPoPZ5i8z2/d350z1zwwkNX9mBtESIvOUDnthQ1OtX6ofY/eUDRl1FWkSQefjm1vuQ2K5aihJC/54Pby851DMgJapGzTnNisjXBJVAEKNNSlsZJMAvomvGE2t2/obzTf8ywlOY2Hw/r3RgxdemgoLu6ek5rWf6lG2wISI9LZdbHus/8kFhRpebGAinmb+R2ZncxLz8y2PYmbQ7CKpG1zE84Syy4u+IjHbwr/Pfnxgu5i0ox8ps/C/90ynIboJ7s8utFaEPuOu5bfhcbhfXN/qgIYbZRljspe/T+P8+eXnVvczZxKo75Dc8K1XLkOPC5whAtEmQTA+7tB5UPQThaeAqXiUv8/F2M9X/n/i+w6v59n4y4Nm90/5OoSYhiDCNwYnx0tFGtldoOUuP7zXtVfKyYL1sv/1itlHROAaXlzsL5JmlB8ecQuMjU+zdQhyMsohAjDBz0O3yRCxUoJYvcjK+H8sWqN/f4Jz29A1j7+4ibMbhwxAUjzWeWtrXS1fZUujBiVR3ip5XjrfRmwnm7Bmt24iM6X9HxhHg9g6Ybqoip80=
          file_glob: true
          file: "*.vsix"
          skip_cleanup: true

        # Publish to the marketplace.
        - provider: script
          script: npm run vsce-publish -- --pat $VSCE_ACCESS_TOKEN
          skip_cleanup: true
